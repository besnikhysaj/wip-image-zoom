function wipImageZoomDirective(e){return{restrict:"EA",template:'<div class="wip-image-zoom {{vm.options.style}}-style {{vm.options.thumbsPos}}-thumbs"\n     ng-class="{\n     \'active\':vm.zoomActive, \n     \'immersive-mode\':vm.immersiveModeActive && !immersive,\n     \'box-style\':vm.options.style == \'box\' ,\n     \'inner-style\':vm.options.style == \'inner\'}">\n\n    <wip-image-zoom-thumbs ng-if="vm.options.thumbsPos === \'top\' && vm.images.length > 1"></wip-image-zoom-thumbs>\n\n    <div class="main-image-wrapper" ng-class="{\'loading\':vm.largeImageLoading}">\n        <div class="image-zoom-tracker" wip-image-zoom-tracker></div>\n        <div class="image-zoom-lens" wip-image-zoom-lens></div>\n        <img class="main-image" ng-src="{{vm.mainImage.medium}}" image-on-load="vm.initZoom()">\n        <div class="zoom-mask"\n             ng-class="vm.options.style == \'box\'? vm.options.boxPos : \'\'"\n             wip-image-zoom-mask>\n            <img wip-image-zoom-image class="zoom-image main-image-large" image-on-load="vm.largeImageLoaded()"\n                 ng-src="{{vm.mainImage.large}}">\n        </div>\n        <div ng-if="vm.immersiveModeActive && !immersive && vm.options.immersiveModeMessage !== \'\'"\n             class="immersive-mode-message" ng-bind="vm.options.immersiveModeMessage"></div>\n    </div>\n\n    <wip-image-zoom-thumbs\n            ng-if="vm.options.thumbsPos === \'bottom\' && vm.images.length > 1"></wip-image-zoom-thumbs>\n</div>',replace:!0,scope:{selectedModel:"=?",selectedIndex:"=?",wipImageZoom:"=",immersive:"=?"},controllerAs:"vm",link:function(e,o,i,m){m.el=o,m.init()},controller:["$scope","$document","$window","$compile",function(o,i,m,t){function n(){N.options=o.wipImageZoom?angular.extend(j,o.wipImageZoom):j,N.images=N.options.images,N.mainImage=N.images[N.options.defaultIndex],o.selectedIndex=N.options.defaultIndex,o.selectedModel=N.mainImage}function s(){S&&e.cancel(S),S=e(function(){g(),a(),x()},400)}function a(){h(),N.zoomTracker.style.cursor=N.options.cursor,N.options.lens?N.zoomLens.style.display="block":N.zoomLens.style.display="none",l(),N.immersiveModeActive=N.options.immersiveMode&&N.options.immersiveMode>m.innerWidth,N.immersiveModeActive&&!o.immersive&&N.zoomTracker.addEventListener("mousedown",c),(!N.immersiveModeActive||o.immersive)&&r()}function r(){N.zoomTracker.addEventListener("mousemove",k),N.zoomTracker.addEventListener("touchstart",k),N.zoomTracker.addEventListener("mouseleave",y),N.zoomTracker.addEventListener("touchend",y),N.zoomTracker.addEventListener("mousemove",b),N.zoomTracker.addEventListener("touchmove",b)}function l(){N.zoomTracker.removeEventListener("mousedown",c),N.zoomTracker.removeEventListener("mousemove",k),N.zoomTracker.removeEventListener("touchstart",k),N.zoomTracker.removeEventListener("mouseleave",y),N.zoomTracker.removeEventListener("touchend",y),N.zoomTracker.removeEventListener("mousemove",b),N.zoomTracker.removeEventListener("touchmove",b)}function d(){i.find("html").removeClass("wip-image-zoom-immersive-mode-enabled"),l(),N.immersedEl.remove(),s()}function c(e){e.preventDefault(),e.stopPropagation(),o.$apply(function(){i.find("html").addClass("wip-image-zoom-immersive-mode-enabled");var e=i.find("body").eq(0);N.immersedImageOpt=angular.copy(N.options),N.immersedImageOpt.style="inner",N.immersedImageOpt.defaultIndex=o.selectedIndex,N.immersedEl=t('<div class="immersive-wip-image-zoom">\n    <div class="disable-immersive-mode-button" ng-click="vm.disableImmersiveMode()">\n        &#10006;</div>\n    <img src="" wip-image-zoom="vm.immersedImageOpt" immersive="true" selected-index="selectedIndex">\n</div>\n')(o),e.append(N.immersedEl),s()})}function g(){N.images.length<=1||(N.thumbsWrapperWidth=N.thumbsWrapper.clientWidth,N.thumbWidth=Math.round((N.thumbsWrapperWidth+N.options.thumbColPadding)/N.options.thumbCol),N.thumbsWidth=N.thumbWidth*N.images.length,N.maxPosX=N.images.length-N.options.thumbCol,o.$evalAsync(function(){"top"==N.options.thumbsPos?(N.thumbsEl.style.paddingBottom=N.options.thumbColPadding+"px",N.thumbsEl.style.paddingTop=0):(N.thumbsEl.style.paddingTop=N.options.thumbColPadding+"px",N.thumbsEl.style.paddingBottom=0);for(var e=0;e<N.thumbsEl.children.length;e++){var o=N.thumbsEl.children[e];o.style.width=N.thumbWidth+"px",o.style.paddingRight=N.options.thumbColPadding+"px"}}))}function u(){p(N.thumbsPos+1)}function v(){p(N.thumbsPos-1)}function p(e){e=0>e?0:e,e=e>N.maxPosX?N.maxPosX:e,N.thumbsPos=e;var o=N.thumbsPos*N.thumbWidth*-1;N.thumbsEl.style.transform="translate3d("+o+"px, 0px, 0)"}function h(){var e=N.zoomTracker.getBoundingClientRect();P=e.width,A=e.height,D=e.left+m.scrollX,W=e.top+m.scrollY,"box"!=N.options.style||o.immersive?(C=P,$=A,N.zoomMaskEl.style.width="100%",N.zoomMaskEl.style.height="100%"):(C=N.options.boxW,$=N.options.boxH,N.zoomMaskEl.style.width=C+"px",N.zoomMaskEl.style.height=$+"px"),N.options.zoomLevel>1&&(N.zoomImageEl.style.width=P*N.options.zoomLevel+"px",N.zoomImageEl.style.height=A*N.options.zoomLevel+"px"),B=N.zoomImageEl.offsetWidth,O=N.zoomImageEl.offsetHeight,z()}function b(e){e.preventDefault();var o="touchmove"==e.type&&e.touches&&e.touches[0];M=o&&o.pageX||e.pageX,Z=o&&o.pageY||e.pageY,w(),"lens"===N.options.method?f():I()}function f(){var e=[(B-C+1*X/H)*[R/P]],o=[(O-$+1*q/H)*[Y/A]];N.zoomImageEl.style.transform="translate3d("+-1*e+"px,"+-1*o+"px,0)"}function I(){var e=[(B-C)*[(M-D)/P]],o=[(O-$)*[(Z-W)/A]];e=D>M?0:e,o=W>Z?0:o,e=M>D+P?B-C:e,o=Z>W+A?O-$:o,N.zoomImageEl.style.transform="translate3d("+-1*e+"px,"+-1*o+"px,0)"}function z(){H=P/B,X=C*H,q=$*H,N.zoomLens.style.width=X+"px",N.zoomLens.style.height=q+"px"}function w(){R=M-D-.5*X,Y=Z-W-.5*q,R=R>P-X?P-X:R,R=0>R?0:R,Y=Y>A-q?A-q:Y,Y=0>Y?0:Y,N.zoomLens.style.transform="translate3d("+R+"px,"+Y+"px,0)"}function x(){if(!(N.images.length<=1)){var e=E(),o=N.thumbsPos+N.options.thumbCol>e&&N.thumbsPos<e;return o?void p(N.thumbsPos):void p(e)}}function E(){for(var e=0;e<N.images.length;e++)if(N.images[e].medium===N.mainImage.medium)return e}function k(){o.$evalAsync(function(){N.zoomActive=!0})}function y(){o.$evalAsync(function(){N.zoomActive=!1})}function T(e){N.largeImageLoading=!0,N.mainImage=e,o.selectedModel=N.mainImage,o.selectedIndex=N.images.indexOf(N.mainImage)}function L(){N.largeImageLoading=!1}var M,Z,P,A,D,W,C,$,B,O,X,q,R,Y,H,N=this,j={defaultIndex:0,images:[],style:"inner",boxPos:"right-top",boxW:400,boxH:400,method:"lens",cursor:"crosshair",lens:!0,zoomLevel:3,immersiveMode:769,immersiveModeMessage:"Click to Zoom",prevThumbButton:"&#9665;",nextThumbButton:"&#9655;",thumbsPos:"bottom",thumbCol:3,thumbColPadding:4},S=!0;N.el,N.zoomTracker,N.zoomLens,N.zoomImageEl,N.thumbsWrapper,N.thumbsEl,N.mainImage,N.options,N.images=[],N.zoomActive=!1,N.largeImageLoading=!0,N.prevThumbActive=!1,N.nextThumbActive=!1,N.thumbWidth,N.thumbsWrapperWidth,N.thumbsWidth,N.thumbsPos=0,N.immersiveModeActive,N.init=n,N.initZoom=a,N.initThumbs=g,N.largeImageLoaded=L,N.updateMainImage=T,N.nextThumb=u,N.prevThumb=v,N.disableImmersiveMode=d,o.$watch("selectedModel",function(e,o){angular.isDefined(e)&&e!==o&&(N.mainImage=e,x())},!0),o.$watch("selectedIndex",function(e,o){angular.isDefined(e)&&e!==o&&(N.mainImage=N.images[e],x())},!0),angular.element(window).on("resize",function(){s()}),m.Ps&&angular.element(document).on("ps-scroll-y",function(){h()}),o.$watch(function(){return{left:N.zoomTracker.getBoundingClientRect().left+m.scrollX,top:N.zoomTracker.getBoundingClientRect().top+m.scrollY}},function(e,o){angular.isDefined(e)&&e!==o&&s()},!0),o.$watch("wipImageZoom",function(e,o){angular.isDefined(e)&&e!==o&&(n(),s())},!0)}]}}function wipImageZoomLensDirective(){return{restrict:"EA",require:"^wipImageZoom",link:function(e,o,i,m){m.zoomLens=o[0]}}}function wipImageZoomTrackerDirective(){return{restrict:"EA",require:"^wipImageZoom",link:function(e,o,i,m){m.zoomTracker=o[0]}}}function wipImageZoomMaskDirective(){return{restrict:"EA",require:"^wipImageZoom",link:function(e,o,i,m){m.zoomMaskEl=o[0]}}}function wipImageZoomImageDirective(){return{restrict:"EA",require:"^wipImageZoom",link:function(e,o,i,m){m.zoomImageEl=o[0]}}}function wipImageZoomThumbsDirective(){return{restrict:"EA",require:"^wipImageZoom",template:'<div class="thumbs-wrapper" ng-swipe-left="vm.nextThumb()" ng-swipe-right="vm.prevThumb()">\n    <div class="thumbs" >\n        <div class="thumb-wrapper" ng-repeat="image in vm.images">\n            <img ng-src="{{image.thumb}}" ng-click="vm.updateMainImage(image)"\n                 ng-class="{\'selected\': vm.mainImage.thumb === image.thumb}">\n        </div>\n    </div>\n</div>\n<div class="prev-button"\n     ng-if="vm.thumbsPos !== 0"\n     ng-click="vm.prevThumb()"\n     ng-bind-html="vm.options.prevThumbButton">Prev\n</div>\n<div class="next-button"\n     ng-if="vm.thumbsPos !== vm.maxPosX"\n     ng-click="vm.nextThumb()"\n     ng-bind-html="vm.options.nextThumbButton">Next\n</div>',link:function(e,o,i,m){m.thumbsWrapper=o[0].getElementsByClassName("thumbs-wrapper")[0],m.thumbsEl=o[0].getElementsByClassName("thumbs")[0],m.initThumbs()}}}function imageOnLoadDirective(e){return{restrict:"A",link:function(o,i,m){i[0].addEventListener("load",function(){o.$apply(m.imageOnLoad)},!1),i[0].addEventListener("error",function(){e.warn("image could not be loaded")})}}}imageOnLoadDirective.$inject=["$log"],wipImageZoomDirective.$inject=["$timeout"],angular.module("wipImageZoom",["ngSanitize","ngTouch"]).directive("imageOnLoad",imageOnLoadDirective).directive("wipImageZoom",wipImageZoomDirective).directive("wipImageZoomTracker",wipImageZoomTrackerDirective).directive("wipImageZoomLens",wipImageZoomLensDirective).directive("wipImageZoomMask",wipImageZoomMaskDirective).directive("wipImageZoomImage",wipImageZoomImageDirective).directive("wipImageZoomThumbs",wipImageZoomThumbsDirective);